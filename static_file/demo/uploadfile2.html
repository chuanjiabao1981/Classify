<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script> 
    <link rel="stylesheet" type="text/css" href="/static_file/js/imagereaselect/css/imgareaselect-animated.css" /> 
    <script type="text/javascript" src="/static_file/js/jquery.form.js"></script> 
    <script type="text/javascript" src="/static_file/js/imagereaselect/scripts/jquery.imgareaselect.pack.js"></script> 


    <script type="text/javascript">
        $(document).ready(function() { 
            var options = { 
                type:       'POST',
                url:        '/uploadimage',
		dataType:    'json',
		success:       showResponse
            }; 
		
	    $('#submit_post_button').click(function(){
                $('#demopost').ajaxSubmit(options);
                return false;
            });
	    $("#submit_post_button")
	    .ajaxComplete(function(){
		$(this).hide();
	    });
	}
	);
	function preview(img, selection) {
    		if (!selection.width || !selection.height)
        	return;
 
    		var scaleX = 100 / selection.width;
    		var scaleY = 100 / selection.height;
 		
    		$('#preview img').css({
        		width: Math.round(scaleX * 200 ),
        		height: Math.round(scaleY * 200 ),
        		marginLeft: -Math.round(scaleX * selection.x1),
        		marginTop: -Math.round(scaleY * selection.y1)
    		});
		
    		$('#x1').val(selection.x1);
    		$('#y1').val(selection.y1);
    		$('#x2').val(selection.x2);
    		$('#y2').val(selection.y2);
    		$('#w').val(selection.width);
    		$('#h').val(selection.height); 
	}

	function showResponse(responseText, statusText, xhr, $form)
	{ 
		document.getElementById('demopost_output').innerHTML = 
		'<img id="tt_tt_tt" src='+responseText.img+' width="200px" height="200px" style="margin:5px 5px 2px 5px"/>';
		document.getElementById('preview').innerHTML = '<img src='+responseText.img+' style="position: relative;" />';
		$('#tt_tt_tt').imgAreaSelect({ handles: true,aspectRatio:'1:1',onSelectChange: preview,x1:30,y1:30,x2:150,y2:150});
		//$('#tt_tt_tt').imgAreaSelect({x1:30,y1:30,x2:120,y2:120,on});

	}
     </script>

</head>
<body>
<form id="demopost" method="POST">
<table>
<tr>
<td>
 <input type="file" name="origin_image" id="fileToUpload" value="选择图片" style="height:22px;font-size:12px"/>
</td>
<td>
 <input id='submit_post_button' type='submit' name='submit_post' value='上传头像' style="height:22px;font-size:12px;"></input>
</td>
</tr>
</table>
</form>
<div style="height:20px"></div>
<form>
<table style="border-collapse: collapse;border-spacing:0px">    
<tr>
	<td rowspan="2" id='demopost_output' style="width:210px;height:210px;border-style:solid;border-width:1px;border-color:green"></td>
	<td id="preview" style="margin-left:20px;float: left; position: relative; overflow-x: hidden; overflow-y: hidden; width: 100px; height: 100px;">
	<div style="border-style:solid;border-width:1px;width:99px;height:99px;border-color:green"></div>
	</td>
</tr>
<tr>
	<td style="height:100px;" valign="top">
		<input   type='hidden' name='x1' value='' id='x1' />
		<input   type='hidden' name='y1' value='' id='y1' />
		<input   type='hidden' name='x2' value='' id='x2' />
		<input   type='hidden' name='y2' value='' id='y2' />
		<input   type='hidden'  name='w' value='' id='w' />
		<input   type='hidden' name='h' value='' id='h' />

		<input type='submit' value='保存头像' style="margin-top:10px;margin-left:35px;height:22px;font-size:12px;"/>
	</td>
</tr>
</form>

</table>
</body>
</html>


